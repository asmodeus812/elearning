<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>10-multi-threading-model</title>
  <style>
    html {
      font-size: 12pt;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  \usepackage{listings}
  \usepackage{xcolor}

  \lstset{
      basicstyle=\ttfamily,
      backgroundcolor=\color{black!10},
      showspaces=false,
      showstringspaces=false,
      showtabs=false,
      tabsize=2,
      captionpos=b,
      breaklines=true,
      breakautoindent=true,
      linewidth=\textwidth
  }
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#threading" id="toc-threading">Threading</a>
<ul>
<li><a href="#thread" id="toc-thread">Thread</a></li>
<li><a href="#synchronization"
id="toc-synchronization">Synchronization</a></li>
<li><a href="#communication"
id="toc-communication">Communication</a></li>
<li><a href="#control" id="toc-control">Control</a></li>
<li><a href="#model" id="toc-model">Model</a></li>
<li><a href="#main" id="toc-main">Main</a></li>
<li><a href="#creating" id="toc-creating">Creating</a></li>
<li><a href="#join" id="toc-join">Join</a></li>
<li><a href="#priority" id="toc-priority">Priority</a></li>
<li><a href="#state" id="toc-state">State</a></li>
<li><a href="#volatile" id="toc-volatile">Volatile</a></li>
<li><a href="#builtin" id="toc-builtin">Builtin</a></li>
<li><a href="#future" id="toc-future">Future</a></li>
</ul></li>
</ul>
</nav>
<h2 id="threading">Threading</h2>
<p>Basically threading is split into two major categories, with which
most people are familiar</p>
<ul>
<li><p>process multi-threading - this is virtually supported by any
modern OS out there, this is the ability of the operating system to run
multiple processes concurrently, each of which has it’s own address and
data space, unrelated to the other process, each process shares a
specific amount of CPU time and all that is governed by the operating
system.</p></li>
<li><p>thread based - this one is related to having multiple threads
execute in the process or the program itself, this allows the program to
perform multiple tasks concurrently, usually this is controlled by the
run-time the program is running on, for our case this is the
JVM.</p></li>
</ul>
<h3 id="thread">Thread</h3>
<p>A thread in java can exist in multiple states - running, stopped,
paused / blocked. In java each thread is assigned a priority, this is
some integral value which is used to determine if the thread should be
given more time to execute, this is very similar to how operating
systems threat multi tasking in process based threading, where there can
be certain processes which are given more cpu time (e.g. When a process
has been idle for a while, it might be given more cpu time next time it
is picked up to effectively “catch up” with execution) thread priority
and process priority can be dynamic, meaning that it can change during
the execution or lifetime of the thread. When a switching from one
thread to another, the run-time does a context switch, this is the same
term used in operating systems when one process is paused before control
is given to another. There are two ways a thread context switch can
occur</p>
<ul>
<li><p>A thread can voluntarily relinquish control - this is usually
done explicitly by the thread, yielding, sleeping or blocking on pending
I/O. Then a higher priority thread is picked from the pool and it’s
execution is re-started</p></li>
<li><p>A thread can be preempted - this is done when a higher priority
thread can cause a lower priority thread. As soon as a higher priority
thread desires to be run, it “overrides” any lower priority thread that
might be running at the current time</p></li>
</ul>
<h3 id="synchronization">Synchronization</h3>
<p>This is a very common problem where multiple threads might want to
operate on the same data/object in this case some sort of resource
locking has to be performed, otherwise there is no guarantee what will
happen with the state of that object or data if multiple threads start
modifying it without any order or structure. The Java run time
implements a way to guard against this with something called
Synchronization, this is the process of which a given object or some of
it’s method can be ‘locked’ for access by any other thread, until the
current one relinquishes control over that synchronized block/method or
data. This way when a given thread enteres a synchronized block it locks
the resource, and any other thread which calls synchronized block on the
same data/resource will block/wait until the lock is released.</p>
<p>This model is the so called monitor model, and each Java object has
an internal <code>monitor</code> associated with it.</p>
<p><code>Any time that you have a method, or group of methods, that manipulates the internal state of an object in a multithreaded situation, you should use the synchronized keyword to guard the state from race conditions. Remember, once a thread enters ANY SYNCHRONIZED METHOD ON AN INSTANCE, NO OTHER THREAD CAN ENTER ANY OTHER SYNCHRONIZED METHOD on the same instance.</code></p>
<p>To synchronize a class or object we have two options really, which
provide different capabilities based on the option we go with, in either
case we have to know that when an object is locked on, either in
synchronize block or a synchronized method is called, the entire object
is locked by the lock monitor</p>
<ul>
<li>Provide synchronize keyword in front of the relevant class members -
variables and/or methods</li>
<li>Wrap an instance of the object in a synchronized block - a way to
synchronize a non-synchronized class</li>
</ul>
<div class="sourceCode" id="cb1"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Synced <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// the entire method is locked, actually the entire instance of Synced is locked by it&#39;s own monitor</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        k<span class="op">++;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Synced <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">synchronize</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// same idea, we are locking the object, however the lock has more fine grained control</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// non synchronized code can be added here, unlike the example above where the entire method locks</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="communication">Communication</h3>
<p>An extension of the synchronize model above, java provides a way to
have multiple threads communicate with each other when a certain
situation has arisen, as discussed the Object class has 3 special final
methods called <code>wait</code> <code>notify</code> and
<code>notifyAll</code>, these are used to have a way to bounce control
between threads when specific conditions are met or not met, in effect
instead of having a thread poll for a state, the thread is paused,on
certain condition, when that condition has changed or has been
fulfilled, the thread can be woken up, and continue its execution the
next time the scheduler picks it up, starting exactly from the position
<code>wait</code> was called</p>
<ul>
<li><p><code>wait()</code> tells the calling thread to give up the
monitor and go to sleep until some other thread enters the same monitor
and calls notify() or notifyAll().</p></li>
<li><p><code>notify()</code> wakes up a thread that called wait() on the
same object.</p></li>
<li><p><code>notifyAll()</code> wakes up all the threads that called
wait() on the same object. One of the threads will be granted
access.</p></li>
</ul>
<p><code>Although wait() normally waits until notify() or notifyAll() is called, there is a possibility that in very rare cases the waiting thread could be awakened due to a spurious wakeup. In this case, a waiting thread resumes without notify() or notifyAll() having been called. (In essence, the thread resumes for no apparent reason.) Because of this remote possibility, Oracle recommends that calls to wait() should take place within a loop that checks the condition on which the thread is waiting.</code></p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> <span class="bu">Queue</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="dt">int</span> value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">boolean</span> valueSet <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">put</span><span class="op">(</span><span class="dt">int</span> v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// if a value is set, wait until the value has been `retrieved` first</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span><span class="op">(</span>valueSet<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                <span class="fu">wait</span><span class="op">();</span> <span class="co">// yield the current thread, until there is no value set</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                <span class="co">// do something with this ex</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// at this point, reaching here means the loop has no sufficed, therefore a valueSet did become false</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// meaning that if it became false, a value was extracted/retrieved see get method below, therefore</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// we are now free to set a new value and reset the valueSet = true again</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">valueSet</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">value</span> <span class="op">=</span> v<span class="op">;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">notifyAll</span><span class="op">();</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">get</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// if a value is not set, wait until the value has been `set` first</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span><span class="op">(!</span>valueSet<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                <span class="fu">wait</span><span class="op">();</span> <span class="co">// yield the current thread, until there is value set</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>                <span class="co">// do something with this ex</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// at this point, reaching here means the loop has not sufficed, therefore a valueSet did become true</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// meaning that if it became true, a value was set/updated see put method above, therefore</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// we are now free to get the value that was set, and reset the valueSet = false</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">valueSet</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">notifyAll</span><span class="op">();</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">value</span><span class="op">;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Consumer <span class="op">{</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Queue</span> q<span class="op">;</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Consumer</span><span class="op">(</span><span class="bu">Queue</span> q<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">q</span> <span class="op">=</span> q<span class="op">;</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="st">&quot;Consumer&quot;</span><span class="op">).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>            q<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Producer <span class="kw">implements</span> <span class="bu">Runnable</span> <span class="op">{</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Queue</span> q<span class="op">;</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">Producer</span><span class="op">(</span><span class="bu">Queue</span> q<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">q</span> <span class="op">=</span> q<span class="op">;</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="st">&quot;Producer&quot;</span><span class="op">).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>            q<span class="op">.</span><span class="fu">put</span><span class="op">(</span>i<span class="op">++);</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a><span class="co">// create both consumer and producer, the producer will keep adding items that the consumer will take from</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a><span class="co">// this is very similar to polling, but here the thread&#39;s state is actually suspended, there is no CPU work</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a><span class="co">// being done to poll for the state of the producer or consumer doing wasted work</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a><span class="bu">Queue</span> q <span class="op">=</span> <span class="kw">new</span> <span class="fu">Q</span><span class="op">();</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="fu">Producer</span><span class="op">(</span>q<span class="op">);</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="fu">Consumer</span><span class="op">(</span>q<span class="op">);</span></span></code></pre></div>
<h3 id="control">Control</h3>
<p>In the past around JDK 2 and prior the Thread class had a few
additional methods, such as suspend, stop and resume, which were used to
control the state of the thread, however those were all deprecated since
they had design issues and could cause the entire program, even the
run-time to terminate execution unexpectedly. The way we do this is to
go back to our trusted wait() and state check. From Java 2 onward it is
preferred and pretty much mandated that the run() implementation checks
on a state or flag based on which it decides to pause the thread with
wait(), this way the API is kept simple and we re-use already existing
methods to control the state of the thread.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyProcess <span class="kw">implements</span> <span class="bu">Runnable</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Thread</span> t<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> needsSuspend <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> workNeedsToBeDone <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">MyProcess</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="st">&quot;myprocess&quot;</span><span class="op">);</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        t<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span><span class="op">(</span>workNeedsToBeDone<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                <span class="co">// long running work process</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">synchronize</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// another thread will either suspend or resume the state of this one</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">while</span><span class="op">(</span>needsSuspend<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">wait</span><span class="op">();</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Child interrupted.&quot;</span><span class="op">);</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Exiting child thread.&quot;</span><span class="op">);</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">suspend</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// will be called and set from another thread</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">needsSuspend</span> <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">resume</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// will be called and set from another thread</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">needsSuspend</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">notifyAll</span><span class="op">();</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>With the example above we can see that now once we create our new
object of type MyProcess, we can control when the execution of the
thread is suspended/paused and when resumed by calling the provided
methods, which will either pause it or resume it.</p>
<h3 id="model">Model</h3>
<p>The Java thread model is build around the Thread class and it’s
companion the Runnable interface. The Thread class provides a way for
the user to interact with the state of the Thread, the Thread object
itself is spawned by other means which will be examined later.</p>
<table>
<thead>
<tr class="header">
<th>Method</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>getName</td>
<td>Obtain a thread’s name.</td>
</tr>
<tr class="even">
<td>getPriority</td>
<td>Obtain a thread’s priority.</td>
</tr>
<tr class="odd">
<td>isAlive</td>
<td>Determine if a thread is still running.</td>
</tr>
<tr class="even">
<td>join</td>
<td>Wait for a thread to terminate.</td>
</tr>
<tr class="odd">
<td>run</td>
<td>Entry point for the thread.</td>
</tr>
<tr class="even">
<td>sleep</td>
<td>Suspend a thread for a period of time.</td>
</tr>
<tr class="odd">
<td>start</td>
<td>Start a thread by calling its run method.</td>
</tr>
</tbody>
</table>
<h3 id="main">Main</h3>
<p>The very first thread which is automatically created by the run-time
is the Main thread, it is the one created first, and very often the one
that is terminated last. One can obtain the current thread, from any
other thread/context by using the public static method of the Thread
class called - <code>currentThread</code>, it will always return, well
the current thread from where it was invoked.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span> args<span class="op">[])</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Thread</span> t <span class="op">=</span> <span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">();</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Current thread: &quot;</span> <span class="op">+</span> t<span class="op">);</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;After name change: &quot;</span> <span class="op">+</span> t<span class="op">);</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> n <span class="op">=</span> <span class="dv">5</span><span class="op">;</span> n <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span> n<span class="op">--)</span> <span class="op">{</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>n<span class="op">);</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">1000</span><span class="op">);</span> <span class="co">// sleep throws checked exception for interrupt</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// this might occur if another thread interrupts the current thread, in that case it has to be handled somehow</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Main thread interrupted&quot;</span><span class="op">);</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="creating">Creating</h3>
<p>To create a thread we have two options really, either subclass Thread
class, which is really not ideal, since when creating a thread we
usually mean to execute some sort of code. The second option which is
the prefered one is to actually implement the <code>runnable</code>
interface, which has only one method called <code>run</code> that will
reprent the code that needs to be run by the thread. When a new Thread
object is created it is not immediately run, instead the caller has to
manually call the <code>start</code> method on the thread object.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NewThread <span class="kw">implements</span> <span class="bu">Runnable</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Thread</span> t<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">NewThread</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create a new, second thread</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="st">&quot;Demo Thread&quot;</span><span class="op">);</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Child thread: &quot;</span> <span class="op">+</span> t<span class="op">);</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        t<span class="op">.</span><span class="fu">start</span><span class="op">();</span> <span class="co">// Start the thread</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">5</span><span class="op">;</span> i <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span> i<span class="op">--)</span> <span class="op">{</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Child Thread: &quot;</span> <span class="op">+</span> i<span class="op">);</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Child interrupted.&quot;</span><span class="op">);</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Exiting child thread.&quot;</span><span class="op">);</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThreadDemo <span class="op">{</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span> args<span class="op">[</span> <span class="op">]</span> <span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="fu">NewThread</span><span class="op">();</span> <span class="co">// create a new thread</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">5</span><span class="op">;</span> i <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span> i<span class="op">--)</span> <span class="op">{</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Main Thread: &quot;</span> <span class="op">+</span> i<span class="op">);</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            <span class="co">// really the interrupted exception here has to be re-thrown or the state of the current thread set to</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">// interrupted again, if we enter here it means we return the control back to this thread which was interrupted</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Main thread interrupted.&quot;</span><span class="op">);</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Main thread exiting.&quot;</span><span class="op">);</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The second option as mentioned is to inherit from Thread instead,
which implements runnable itself, the Thread class actually is neither
abstract nor does it require us to override runnable. What it does is it
is a wrapper around a runnable object instance, if it was set during the
creation of the thread it is run, below is the default run
implementation of Thread. Meaning that we can actually create a thread
object that does nothing by passing <code>nil</code> as the target
runnable.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>target <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        target<span class="op">.</span><span class="fu">run</span><span class="op">();</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>The catching of InterruptedException is exceptional case, if a thread is blocking, the run-time will silently pass control to another thread while the current one is sleeping or otherwise occupied, this will NOT cause interrupted exception, the exception is for situations where the thread is manually interrupted or killed by another one, which is a case we have to handle if we expect to terminate the thread prematurely</code></p>
<h3 id="join">Join</h3>
<h3 id="priority">Priority</h3>
<p>The thread priority specifies how a given thread is threated by the
java run-time when it comes time for a thread to be paused or even
preempted, in the scenarios above all threads are created with default
priority and in general all threads must be picked up by default at
least for an equal amount of time, however that is highly dependent on
the system on which the program is running, and is not something that
can be relied on. Further more if the operating system does not support
preempting (overruling the execution of the current thread, for one with
higher priority) then specifying the priority of a thread is somewhat
meaningless</p>
<p>To set a thread’s priority, use the setPriority( ) method, which is a
member of Thread. This is its general form:
<code>final void setPriority(int level)</code> Here, level specifies the
new priority setting for the calling thread. The value of level must be
within the range MIN_PRIORITY and MAX_PRIORITY. Currently, these values
are 1 and 10, respectively. To return a thread to default priority,
specify NORM_PRIORITY, which is currently 5. These priorities are
defined as static final variables within Thread.</p>
<p><code>One should not rely on threads being controlled by preempting, meaning that we should avoid setting priority and let the threads automatically relinquish or gain control instead</code></p>
<h3 id="state">State</h3>
<p>The <code>getState()</code> method existing on a thread is used to
obtain more information about the thread, which provides the exact state
of the thread at the current time of invocation. Note that we have other
means of getting some sort of state from a thread such as
<code>isAlive, isDaemon or isInterrupted</code></p>
<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 93%" />
</colgroup>
<thead>
<tr class="header">
<th>Value</th>
<th>State</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>BLOCKED</td>
<td>A thread that has suspended execution because it is waiting to
acquire a lock.</td>
</tr>
<tr class="even">
<td>NEW</td>
<td>A thread that has not begun execution.</td>
</tr>
<tr class="odd">
<td>RUNNABLE</td>
<td>A thread that either is currently executing or will execute when it
gains access to the CPU.</td>
</tr>
<tr class="even">
<td>TERMINATED</td>
<td>A thread that has completed execution.</td>
</tr>
<tr class="odd">
<td>TIMED_WAITING</td>
<td>A thread that has suspended execution for a specified period of
time, such as when it has called sleep( ). This state is also entered
when a timeout version of wait( ) or join( ) is called.</td>
</tr>
<tr class="even">
<td>WAITING</td>
<td>A thread that has suspended execution because it is waiting for some
action to occur. For example, it is waiting because of a call to a
non-timeout version of wait( ) or join( ).</td>
</tr>
</tbody>
</table>
<pre><code>                           new
                            |
           &lt; Lock wait      |         Paused &gt;
blocked ---------------- runnable ---------------- waiting
         Lock aquired &gt;     |         &lt; Resumed
                            |
                        terminated
</code></pre>
<h3 id="volatile">Volatile</h3>
<p>A very interesting modifier keyword, that can be placed on member
variables, the idea behind it is that in a threaded environment, when an
object is shared between multiple threads, each thread might create a
thread local copy of each variable of an object which it accesses, this
is usually done on a per <code>cpu-core</code> <code>level</code>, in
the L-level caches, however, this can be error prone. Reason being is
that if only one thread modifies a variable and every other thread reads
it, when the thread that modifies it, changes the variable, it might not
become immediately visible to the <code>reader</code> threads,
<code>volatile</code> ensures that all threads see the same value, in
other words the value is not cached, meaning it is likely written out to
main memory and read from memory on each access, that can be somewhat
slow, so use the volatile keyword with caution.</p>
<p>It is important to note that when a <code>synchronize</code> block is
exited, the member variables are updated, the cache is flushed, and data
written out to main memory, but that can often be way too much for
simple reader threads, which do not wish to lock the entire object and
synchronize on it simply to guarantee they see the most up-to date
value. This is where volatile comes in handy, also it is on
<code>per</code> member, instead of <code>per</code> entire object, it
does not force the entire object to be flushed out to memory and out of
the cpu cache</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> b<span class="op">;</span> <span class="co">// this is not marked as volatile, meaning that writes to this value, might not be immedately visible to other reading threads</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">volatile</span> <span class="dt">byte</span> k<span class="op">;</span> <span class="co">// ensure that k is not cached in L-level cache in the cpu, and threads see the most recent value</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>Writes to a volatile variable happen-before subsequent reads of that volatile variable by any thread.</code></p>
<h3 id="builtin">Builtin</h3>
<p>The standard concurrency library provides means of wrapping common
threading patterns around a well defined interfaces and classes. One
such is the <code>Executor</code> and <code>ExecutorService</code>.
These interfaces provides means of executing tasks in a concurrent
manner without having to worry about the underlying implementation.
However there are some key implementations of this interface which find
common use in the wild. The <code>Executor</code> interface is the top
level interface which provides a singular method, to execute a Runnable
task, the <code>ExecutorService</code> provides more sophisticated means
of:</p>
<ol type="1">
<li><p><code>Task Submission</code>: You can submit
<code>Runnable</code> and Callable tasks for execution.</p></li>
<li><p><code>Life cycle Management</code>: It provides methods to
control the <code>lifecycle</code> of the executor, such as starting,
stopping, and checking if it is terminated.</p></li>
<li><p><code>Future Management</code>: The <code>ExecutorService</code>
returns Future objects that represent the result of the asynchronous
computation, allowing you to retrieve the result or handle
exceptions.</p></li>
<li><p><code>Thread Pool Management</code>: It can manage a pool of
threads, allowing for efficient reuse of threads and reducing the
overhead associated with thread creation.</p></li>
</ol>
<h4 id="threadpertaskexecutor">ThreadPerTaskExecutor</h4>
<p>The most basic executor, it implements the <code>Executor</code>
interface, not the <code>ExecutorService</code> which means that this
class exposes only one single method <code>execute</code> and each is
run on a separate thread. Should not really be used in production
environment</p>
<h4 id="threadpoolexecutor">ThreadPoolExecutor</h4>
<p>The pool executor is a more sophisticated verision of the
<code>ThreadPerTaskExecutor</code> which uses pooling of threads to
execute tasks. Used for one short, short lived, non repeatable tasks,
the pool executor can be configured, meaning it can be created with a
specific fixed number of threads in the pool, and various other
parameters can be changed.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ExecutorService</span> executor <span class="op">=</span> <span class="kw">new</span> <span class="bu">ThreadPoolExecutor</span><span class="op">(</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span><span class="op">,</span> <span class="co">// core pool size</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span><span class="op">,</span> <span class="co">// max pool size</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">60</span><span class="op">,</span> <span class="co">// keep-alive time for extra threads</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">SECONDS</span><span class="op">,</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">LinkedBlockingQueue</span><span class="op">&lt;</span><span class="bu">Runnable</span><span class="op">&gt;()</span> <span class="co">// task queue</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>executor<span class="op">.</span><span class="fu">submit</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Task implementation</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>executor<span class="op">.</span><span class="fu">shutdown</span><span class="op">();</span></span></code></pre></div>
<h4 id="scheduledthreadpoolexecutor">ScheduledThreadPoolExecutor</h4>
<p>The scheduled executor is a sub-class of the
<code>ThreadPoolExecutor</code> and is meant to be used for execution of
tasks after a given delay, or to execute tasks periodically after a
given interval, one can use the <code>ScheduledThreadPoolExecutor</code>
to schedule tasks to be executed in the future</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ScheduledExecutorService</span> scheduler <span class="op">=</span> <span class="bu">Executors</span><span class="op">.</span><span class="fu">newScheduledThreadPool</span><span class="op">(</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>scheduler<span class="op">.</span><span class="fu">schedule</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Task to execute after a delay</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="op">},</span> <span class="dv">10</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">SECONDS</span><span class="op">);</span> <span class="co">// Execute after 10 seconds</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>scheduler<span class="op">.</span><span class="fu">shutdown</span><span class="op">();</span></span></code></pre></div>
<h4 id="cachedthreadpool">CachedThreadPool</h4>
<p>This implementation creates new thread for each task but will reuse
previously constructed threads when they are available, it is unbounded,
meaning it can grow to accommodate as many threads as needed, suitable
for many short lived tasks, where thread per task creation is justified.
The cached thread pool is still using pooling however, the pool is
unbounded, so unlike the <code>ThreadPoolExecutor</code> which has a
fixed number of threads that can be used, the
<code>CachedThreadPool</code> can grow its internal pool of threads
based on throughput, the more tasks that come in the more threads are
created, once a task frees up a thread from the cached pool, if within
some period of time that thread is not-reused by a new task, or a new
task does not come in, the thread is removed/destroyed from the pool.
This allows the <code>CachedThreadPool</code> to scale the thread count
based on the incoming number of tasks, something that the
<code>ThreadPoolExecutor</code> can not do, since it will always have a
fixed number of thread allocated.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ExecutorService</span> executor <span class="op">=</span> <span class="bu">Executors</span><span class="op">.</span><span class="fu">newCachedThreadPool</span><span class="op">();</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>executor<span class="op">.</span><span class="fu">submit</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Task implementation</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>executor<span class="op">.</span><span class="fu">shutdown</span><span class="op">();</span></span></code></pre></div>
<h4 id="fixedthreadpool">FixedThreadPool</h4>
<p>This implementation is very similar to the
<code>ThreadPoolExecutor</code> since it also provides a fixed number of
threads in a pool which can execute tasks, however the
<code>FixedThreadPool</code> provides less flexibility in the way it can
be configured compared to the <code>ThreadPoolExecutor</code>. The
configuration of the <code>FixedThreadPool</code> allows one to only
provide the number of threads in the pool, and that is about it, while
the <code>ThreadPerTaskExecutor</code> provides quite a wide variety of
configuration options.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ExecutorService</span> executor <span class="op">=</span> <span class="bu">Executors</span><span class="op">.</span><span class="fu">newFixedThreadPool</span><span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>executor<span class="op">.</span><span class="fu">submit</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Task implementation</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>executor<span class="op">.</span><span class="fu">shutdown</span><span class="op">();</span></span></code></pre></div>
<h4 id="singlethreadexecutor">SingleThreadExecutor</h4>
<p>This executor creates a single thread, which is used to execute tasks
sequentially, the tasks are queued, and after one finishes the next one
is scheduled for execution, useful for scenarios where you need to
execute tasks in a particular order, or if the output of one is used as
the input of the other, and they need to be chain executed.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ExecutorService</span> executor <span class="op">=</span> <span class="bu">Executors</span><span class="op">.</span><span class="fu">newSingleThreadExecutor</span><span class="op">();</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>executor<span class="op">.</span><span class="fu">submit</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Task implementation</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>executor<span class="op">.</span><span class="fu">shutdown</span><span class="op">();</span></span></code></pre></div>
<h4 id="forkjoinpool">ForkJoinPool</h4>
<p>This executor service implementation is a specialized implementation
of the <code>ExecutorService</code>, designed with for work-stealing
algorithms and tasks. The work-stealing is the primary benefit of using
a <code>ForkJoinPool</code>. The <code>ForkJoinPool</code> is by default
created with a fixed number of threads, just as the
<code>ThreadPoolExecutor</code>, however, it employs work-stealing, the
way work-stealing works is that each thread is assigned a
<code>deque/queue</code> of tasks that will be run, usually assigned to
each thread in the pool, in a round robin way. Now if a particular
thread finishes all tasks it was assigned to, it can steal tasks from
the queue of other threads, which still have pending tasks, usually the
work stealing will try to balance pulling tasks from the queue of other
threads. The <code>ForkJoinPool</code> is very useful for tasks which
are recursive, since the tasks can be distributed evenly, and the
threads from the pool will not be idle, since they will pull work from
other threads, in case the thread finishes all tasks assigned to it. For
example algorithms such as merge-sort, quick-sort, and other divide and
conquer algorithms which are recursive in nature can greatly benefit
from using a <code>ForkJoinPool</code>, instead of
<code>ThreadPoolExecutor</code>, this is due to the fact that the
<code>ThreadPoolExecutor</code> does not re-distribute tasks among free
threads, the only way to make a free thread work, is by issuing a new
task, then a free thread from the pool will pick it up, however, in the
<code>ForkJoinPool</code> there will always be a thread with a running
task until there are no longer tasks to run. The
<code>ForkJoinPool</code> is very useful for a particular task which can
be split into multiple stages, such as many algorithms, mentioned above,
unlike the <code>ThreadPoolExecutor</code> which is tailored more
towards completely independent long running tasks.</p>
<h3 id="future">Future</h3>
<p>This interface is very closely related to the <code>Executor</code>
and <code>ExecutorService</code> interfaces, it provides an API wrapping
a unit of computation for which the client can obtain the result without
blocking the current thread, check if the status of the task is
completed, had an exception. In general the methods in the
<code>ExecutorService</code> return some sort of implementation or
sub-interface of <code>Future</code> they return a <code>promise</code>
of sorts, which can be queried, possible results extracted and so on.
The <code>Future</code> interface and the <code>Executor</code> work in
tandem to complete the user interaction with asynchronous task
management</p>
<p>When one submits a task to an <code>ExecutorService</code> using the
<code>submit()</code> method, it returns a <code>Future</code> object
that represents the pending result of the task. This allows you to check
the status of the task and retrieve the result once it has
completed.</p>
<h4 id="futuretask">FutureTask</h4>
<p>This implementation of <code>Future</code> acts as a wrapper around
<code>Runnable</code> and <code>Future</code>. Basically what it
provides is means of creating a self-canceling runnable task. Meaning
that while <code>submit</code> method on <code>ExecutorService</code>
does return a <code>Feature</code> which can be used to cancel the
running task, the task itself can not be canceled from within the task,
however the <code>FutureTask</code> provides the user with the ability
to terminate itself during the execution (e.g. when a given state or
result is reached or not reached, the task can stop execution of
itself).</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Callable</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> callableTask <span class="op">=</span> <span class="op">()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simulate a long-running task</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">2000</span><span class="op">);</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;Task Completed&quot;</span><span class="op">;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="bu">FutureTask</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> futureTask <span class="op">=</span> <span class="kw">new</span> <span class="bu">FutureTask</span><span class="op">&lt;&gt;(</span>callableTask<span class="op">);</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="bu">ExecutorService</span> executor <span class="op">=</span> <span class="bu">Executors</span><span class="op">.</span><span class="fu">newFixedThreadPool</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>executor<span class="op">.</span><span class="fu">submit</span><span class="op">(</span>futureTask<span class="op">);</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Retrieve the result</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> <span class="op">{</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> result <span class="op">=</span> futureTask<span class="op">.</span><span class="fu">get</span><span class="op">();</span> <span class="co">// This will block until the result is available</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>result<span class="op">);</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> <span class="op">|</span> <span class="bu">ExecutionException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    executor<span class="op">.</span><span class="fu">shutdown</span><span class="op">();</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="completablefuture">CompletableFuture</h4>
<p>This particular implementation of the Future interface, allows one to
chain and transform computation operations which are going to be run in
an executor. By default the <code>CompletableFuture</code> uses a
<code>ForkJoinPool</code>, this implementation is done in the
<code>CompletableFuture</code> interface. Similarly to
<code>Stream</code>s the <code>CompletableFuture</code>s have two types
of operations</p>
<p>Finalizing and composing. The finalizing operations are such that
they will block the current thread until the future completes The
composing operations, similarly to streams will chain the future, with
other futures, it is important to note that upon registering an
composing operation the operation will be schedule for running on the
executor, if further chaining is done through composing operations, the
are done by chaining on the previous instance, each new chaining
operation (thenCompose, thenApply, thenCombine etc) will either register
a new task in the executor if the future from which it is being chained
from is not complete or immediately start executing if the future is
complete.</p>
<p><code>The chaining pattern used in CompletableFuture is very similar to how Stream chaining work, however unlike streams processing begins immediately as soon as the previous future in the chain has completed/has result, instead of when calling a terminating operation with Streams</code></p>
<h5 id="finalizing-operations">Finalizing operations</h5>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 81%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Method</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>get()</td>
<td>Waits for the future to complete and retrieves its result, blocking
the calling thread if necessary.</td>
</tr>
<tr class="even">
<td>join()</td>
<td>Similar to <code>get()</code>, but throws an unchecked
<code>CompletionException</code> if the computation fails.</td>
</tr>
<tr class="odd">
<td>thenAccept(Consumer)</td>
<td>Consumes the result without returning a new
<code>CompletableFuture</code>, useful for performing side effects.</td>
</tr>
<tr class="even">
<td>thenRun(Runnable)</td>
<td>Runs a <code>Runnable</code> after the computation is complete,
regardless of the result.</td>
</tr>
<tr class="odd">
<td>whenComplete(BiConsumer)</td>
<td>Executes a <code>BiConsumer</code> after the completion of the
future, providing both the result and exception.</td>
</tr>
<tr class="even">
<td>handle(BiFunction)</td>
<td>Similar to <code>whenComplete</code>, but allows for recovery or
transformation of the result if an exception occurs.</td>
</tr>
</tbody>
</table>
<h5 id="composing-operations">Composing operations</h5>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Method</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>thenApply(Function)</td>
<td>Applies a function to the result of the future, returning a new
<code>CompletableFuture</code> with the transformed result.</td>
</tr>
<tr class="even">
<td>thenCompose(Function)</td>
<td>Chains another <code>CompletableFuture</code> that depends on the
result of the current one, allowing for dependent async tasks.</td>
</tr>
<tr class="odd">
<td>thenCombine(CompletableFuture, BiFunction)</td>
<td>Combines the results of two <code>CompletableFuture</code>s when
both complete, using a function to produce a final result.</td>
</tr>
<tr class="even">
<td>thenAcceptBoth(CompletableFuture, BiConsumer)</td>
<td>Applies a <code>BiConsumer</code> to the results of two futures
without returning a result.</td>
</tr>
<tr class="odd">
<td>applyToEither(CompletableFuture, Function)</td>
<td>Applies a function to whichever of two futures completes first.</td>
</tr>
<tr class="even">
<td>acceptEither(CompletableFuture, Consumer)</td>
<td>Similar to <code>applyToEither</code>, but applies a
<code>Consumer</code> to the first result without returning a new
future.</td>
</tr>
<tr class="odd">
<td>exceptionally(Function)</td>
<td>Returns a new <code>CompletableFuture</code> that handles exceptions
and can provide a fallback value.</td>
</tr>
</tbody>
</table>
<h5 id="factory-operations">Factory operations</h5>
<ul>
<li><p><code>supplyAsync</code> - Starts execution of a task that
produces a result, has a generic return type of T</p></li>
<li><p><code>runAsync</code> - Starts execution of a task that does not
produce a result i.e. has a void return type</p></li>
<li><p><code>completedFuture</code> - Returns a future that is already
completed with a specified value. This works as if a future was created,
task was run, completed and a result was produced.</p></li>
<li><p><code>newIncompleteFuture</code> - Creates a new complete-able
future, without a task, use <code>composing</code> and
<code>finalizing</code> operations to complete it</p></li>
</ul>
<p><code>Note, the factory operations above provide means of creating a completeable future, in different states, there are mostly two - already running a given task, or one that is not initialized with any task and has to be registered into an executor service to begin execution.</code></p>
<p>In the example below one can see how multiple
<code>CompletableFuture</code> are created, each of which depends on the
previous, using compose (<code>thenCompose</code>) the result of a
previous future is used as an input to the next, however they are
executed asynchronously but in order. When one calls
<code>supplyAsync</code> on a future instance, the task is
<code>immediately</code> scheduled for execution, it returns a new
instance of <code>CompletableFuture</code> which can be further chained
with more <code>supplyAsync</code> calls, the next call to
<code>supplyAsync</code> will either schedule a task to be run after the
first future completes / has result, or if the first future is already
finished, the second call to <code>supplyAsync</code> will be
immediately scheduled for execution.</p>
<p>Note that <code>get</code> will block the current thread until the
task is finished, so it is best to execute some other long running task
between the calls to <code>thenAccept</code> and <code>get</code> to
make sure there is no idle current thread time</p>
<p><code>It is important to remember that chained calls to supplyAsync, will start the task as soon as possible only if the result of the previous future is complete, that is not applicable only for the very first future in the chain, it does not need to wait for result, it can start immediately</code></p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    OrderProcessing orderProcessing <span class="op">=</span> <span class="kw">new</span> <span class="fu">OrderProcessing</span><span class="op">();</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    orderProcessing<span class="op">.</span><span class="fu">processOrder</span><span class="op">(</span><span class="dv">123</span><span class="op">);</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">processOrder</span><span class="op">(</span><span class="dt">int</span> orderId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    CompletableFuture<span class="op">&lt;</span>User<span class="op">&gt;</span> userFuture <span class="op">=</span> <span class="fu">fetchUserDetails</span><span class="op">(</span>orderId<span class="op">);</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    CompletableFuture<span class="op">&lt;</span>Payment<span class="op">&gt;</span> paymentFuture <span class="op">=</span> userFuture<span class="op">.</span><span class="fu">thenCompose</span><span class="op">(</span>user <span class="op">-&gt;</span> <span class="fu">processPayment</span><span class="op">(</span>user<span class="op">));</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    CompletableFuture<span class="op">&lt;</span><span class="bu">Void</span><span class="op">&gt;</span> confirmationFuture <span class="op">=</span> paymentFuture<span class="op">.</span><span class="fu">thenAccept</span><span class="op">(</span>payment <span class="op">-&gt;</span> <span class="fu">sendConfirmation</span><span class="op">(</span>payment<span class="op">));</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// after calling `supplyAsync`, the future tasks are already being executed, inside the thread executor pool</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// therefore the current thread is not blocked and more tasks can be run at this point while the result of the</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// `confirmationFuture` is being computed</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        confirmationFuture<span class="op">.</span><span class="fu">get</span><span class="op">();</span> <span class="co">// obtain the final result</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Order processed successfully.&quot;</span><span class="op">);</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> <span class="op">|</span> <span class="bu">ExecutionException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> CompletableFuture<span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">fetchUserDetails</span><span class="op">(</span><span class="dt">int</span> orderId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> CompletableFuture<span class="op">.</span><span class="fu">supplyAsync</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sleep</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span> <span class="co">// Simulate delay</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Fetched user details for order &quot;</span> <span class="op">+</span> orderId<span class="op">);</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="st">&quot;John Doe&quot;</span><span class="op">,</span> <span class="st">&quot;john.doe@example.com&quot;</span><span class="op">);</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> CompletableFuture<span class="op">&lt;</span>Payment<span class="op">&gt;</span> <span class="fu">processPayment</span><span class="op">(</span>User user<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> CompletableFuture<span class="op">.</span><span class="fu">supplyAsync</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sleep</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span> <span class="co">// Simulate delay</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Processed payment for user: &quot;</span> <span class="op">+</span> user<span class="op">.</span><span class="fu">getName</span><span class="op">());</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Payment</span><span class="op">(</span><span class="st">&quot;12345&quot;</span><span class="op">,</span> <span class="fl">99.99</span><span class="op">);</span> <span class="co">// Simulate a successful payment</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">sendConfirmation</span><span class="op">(</span>Payment payment<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span> <span class="co">// Simulate delay</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Sent confirmation email for payment ID: &quot;</span> <span class="op">+</span> payment<span class="op">.</span><span class="fu">getPaymentId</span><span class="op">());</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">sleep</span><span class="op">(</span><span class="dt">int</span> seconds<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">SECONDS</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span>seconds<span class="op">);</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">interrupt</span><span class="op">();</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</body>
</html>
